<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure AI Chat - セルフサインアップ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .signup-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            margin-right: 8px;
        }

        .step.active .step-number {
            background: #667eea;
            color: white;
        }

        .step.completed .step-number {
            background: #4CAF50;
            color: white;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .form-group.has-error input {
            border-color: #e74c3c;
        }

        .form-group.has-error .error {
            display: block;
        }

        .form-group .success {
            color: #27ae60;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .form-group.has-success input {
            border-color: #27ae60;
        }

        .form-group.has-success .success {
            display: block;
        }

        .subdomain-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
            font-family: monospace;
            color: #6c757d;
        }

        .plan-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .plan-card {
            border: 2px solid #e1e1e1;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .plan-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .plan-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .plan-card .plan-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .plan-card .plan-price {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .plan-card .plan-features {
            list-style: none;
            padding: 0;
        }

        .plan-card .plan-features li {
            padding: 4px 0;
            display: flex;
            align-items: center;
        }

        .plan-card .plan-features li:before {
            content: "✓";
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
        }

        .recommended {
            position: absolute;
            top: -10px;
            right: 20px;
            background: #FF6B6B;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .trial-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .password-strength {
            margin-top: 5px;
            font-size: 14px;
        }

        .strength-bar {
            height: 4px;
            background: #e1e1e1;
            border-radius: 2px;
            margin: 5px 0;
        }

        .strength-bar.weak { background: #e74c3c; width: 25%; }
        .strength-bar.fair { background: #f39c12; width: 50%; }
        .strength-bar.good { background: #f1c40f; width: 75%; }
        .strength-bar.strong { background: #27ae60; width: 100%; }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .plan-cards {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Secure AI Chat</h1>
            <p>企業向けセキュアAIチャットサービス - 無料トライアル開始</p>
        </div>

        <div class="content">
            <!-- ステップインジケーター -->
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <span>会社情報</span>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <span>プラン選択</span>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <span>管理者情報</span>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <span>完了</span>
                </div>
            </div>

            <!-- エラー・成功メッセージ -->
            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>

            <form id="signupForm">
                <!-- ステップ1: 会社情報 -->
                <div class="form-section active" data-section="1">
                    <h3>会社情報を入力してください</h3>
                    
                    <div class="form-group">
                        <label for="companyName">会社名 <span style="color: red;">*</span></label>
                        <input type="text" id="companyName" name="company_name" required 
                               placeholder="例: 株式会社サンプル">
                        <div class="error">会社名は2文字以上100文字以内で入力してください</div>
                    </div>

                    <div class="form-group">
                        <label for="subdomain">サブドメイン <span style="color: red;">*</span></label>
                        <input type="text" id="subdomain" name="subdomain" required 
                               placeholder="例: sample-company" pattern="[a-z0-9-]+">
                        <div class="subdomain-preview">
                            あなたのURL: <strong><span id="subdomainPreview">yourcompany</span>.secure-ai-chat.com</strong>
                        </div>
                        <div class="error">英数字とハイフンのみ、3-20文字で入力してください</div>
                        <div class="success">このサブドメインは利用可能です</div>
                    </div>
                </div>

                <!-- ステップ2: プラン選択 -->
                <div class="form-section" data-section="2">
                    <h3>プランを選択してください</h3>
                    
                    <div class="trial-info">
                        <i class="fas fa-info-circle"></i>
                        すべてのプランで14日間の無料トライアルをご利用いただけます
                    </div>

                    <div class="plan-cards" id="planCards">
                        <!-- プランカードはJavaScriptで動的生成 -->
                    </div>
                </div>

                <!-- ステップ3: 管理者情報 -->
                <div class="form-section" data-section="3">
                    <h3>管理者アカウント情報を入力してください</h3>
                    
                    <div class="form-group">
                        <label for="adminName">管理者名 <span style="color: red;">*</span></label>
                        <input type="text" id="adminName" name="admin_name" required 
                               placeholder="例: 田中太郎">
                        <div class="error">管理者名を入力してください</div>
                    </div>

                    <div class="form-group">
                        <label for="adminEmail">メールアドレス <span style="color: red;">*</span></label>
                        <input type="email" id="adminEmail" name="admin_email" required 
                               placeholder="例: admin@yourcompany.com">
                        <div class="error">有効なメールアドレスを入力してください</div>
                    </div>

                    <div class="form-group">
                        <label for="adminPassword">パスワード <span style="color: red;">*</span></label>
                        <input type="password" id="adminPassword" name="admin_password" required 
                               placeholder="8文字以上、英数字を含む">
                        <div class="password-strength">
                            <div class="strength-bar" id="strengthBar"></div>
                            <span id="strengthText">パスワード強度</span>
                        </div>
                        <div class="error">8文字以上で英数字を含むパスワードを設定してください</div>
                    </div>
                </div>

                <!-- ステップ4: 完了 -->
                <div class="form-section" data-section="4">
                    <div style="text-align: center;">
                        <i class="fas fa-check-circle" style="font-size: 4rem; color: #4CAF50; margin-bottom: 20px;"></i>
                        <h3>アカウント作成完了！</h3>
                        <p>ウェルカムメールを送信しました。<br>
                        メール内のリンクからアカウントを有効化してください。</p>
                        
                        <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h4>次のステップ:</h4>
                            <ol style="text-align: left; margin: 15px 0;">
                                <li>メールアドレスの確認</li>
                                <li>チームメンバーの招待</li>
                                <li>API設定の選択</li>
                                <li>初回AIチャットのテスト</li>
                            </ol>
                        </div>

                        <a href="#" id="dashboardLink" class="btn btn-primary">
                            <i class="fas fa-external-link-alt"></i>
                            ダッシュボードを開く
                        </a>
                    </div>
                </div>

                <!-- ナビゲーションボタン -->
                <div class="buttons">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> 戻る
                    </button>
                    
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        次へ <i class="fas fa-arrow-right"></i>
                    </button>
                    
                    <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
                        <span class="loading" style="display: none;"></span>
                        <i class="fas fa-rocket"></i> 
                        アカウント作成
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class SignupWizard {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 4;
                this.plans = [];
                this.selectedPlan = 'standard';
                this.signupData = {};
                
                this.init();
            }

            async init() {
                this.bindEvents();
                await this.loadPlans();
                this.updateStepIndicator();
            }

            bindEvents() {
                // ナビゲーションボタン
                document.getElementById('nextBtn').addEventListener('click', () => this.nextStep());
                document.getElementById('prevBtn').addEventListener('click', () => this.prevStep());
                document.getElementById('signupForm').addEventListener('submit', (e) => this.handleSubmit(e));

                // サブドメインリアルタイム検証
                document.getElementById('subdomain').addEventListener('input', (e) => {
                    this.updateSubdomainPreview(e.target.value);
                    this.debounce(() => this.checkSubdomainAvailability(e.target.value), 500)();
                });

                // パスワード強度チェック
                document.getElementById('adminPassword').addEventListener('input', (e) => {
                    this.updatePasswordStrength(e.target.value);
                });

                // フォームバリデーション
                ['companyName', 'subdomain', 'adminName', 'adminEmail', 'adminPassword'].forEach(id => {
                    document.getElementById(id).addEventListener('blur', (e) => this.validateField(e.target));
                });
            }

            async loadPlans() {
                try {
                    const response = await fetch('/api/v1/plans');
                    const data = await response.json();
                    this.plans = data.plans;
                    this.renderPlanCards();
                } catch (error) {
                    console.error('プラン読み込みエラー:', error);
                    // デフォルトプランを使用
                    this.plans = [
                        {
                            id: 'starter',
                            name: 'Starter',
                            max_users: 10,
                            max_tokens_per_month: 100000,
                            price_monthly: 29800,
                            trial_days: 14
                        },
                        {
                            id: 'standard',
                            name: 'Standard',
                            max_users: 50,
                            max_tokens_per_month: 500000,
                            price_monthly: 49800,
                            trial_days: 14,
                            recommended: true
                        },
                        {
                            id: 'professional',
                            name: 'Professional',
                            max_users: 200,
                            max_tokens_per_month: 2000000,
                            price_monthly: 98000,
                            trial_days: 30
                        },
                        {
                            id: 'enterprise',
                            name: 'Enterprise',
                            max_users: 9999,
                            max_tokens_per_month: 10000000,
                            price_monthly: 198000,
                            trial_days: 30
                        }
                    ];
                    this.renderPlanCards();
                }
            }

            renderPlanCards() {
                const container = document.getElementById('planCards');
                container.innerHTML = '';

                this.plans.forEach(plan => {
                    const card = document.createElement('div');
                    card.className = `plan-card ${plan.id === this.selectedPlan ? 'selected' : ''}`;
                    card.dataset.plan = plan.id;
                    
                    card.innerHTML = `
                        ${plan.recommended ? '<div class="recommended">おすすめ</div>' : ''}
                        <div class="plan-name">${plan.name}</div>
                        <div class="plan-price">¥${plan.price_monthly.toLocaleString()}<small>/月</small></div>
                        <ul class="plan-features">
                            <li>最大 ${plan.max_users} ユーザー</li>
                            <li>月間 ${plan.max_tokens_per_month.toLocaleString()} トークン</li>
                            <li>${plan.trial_days}日間無料トライアル</li>
                            <li>メールサポート</li>
                            ${plan.id !== 'starter' ? '<li>カスタムAPI設定</li>' : ''}
                            ${plan.id === 'professional' || plan.id === 'enterprise' ? '<li>電話サポート</li>' : ''}
                            ${plan.id === 'enterprise' ? '<li>専任サポート</li>' : ''}
                        </ul>
                    `;

                    card.addEventListener('click', () => this.selectPlan(plan.id));
                    container.appendChild(card);
                });
            }

            selectPlan(planId) {
                this.selectedPlan = planId;
                document.querySelectorAll('.plan-card').forEach(card => {
                    card.classList.toggle('selected', card.dataset.plan === planId);
                });
            }

            updateSubdomainPreview(value) {
                const preview = document.getElementById('subdomainPreview');
                preview.textContent = value || 'yourcompany';
            }

            async checkSubdomainAvailability(subdomain) {
                if (!subdomain || subdomain.length < 3) return;

                try {
                    const response = await fetch(`/api/v1/check-subdomain/${subdomain}`);
                    const data = await response.json();
                    
                    const group = document.getElementById('subdomain').closest('.form-group');
                    group.classList.remove('has-error', 'has-success');
                    
                    if (data.available) {
                        group.classList.add('has-success');
                    } else {
                        group.classList.add('has-error');
                        group.querySelector('.error').textContent = data.message;
                    }
                } catch (error) {
                    console.error('サブドメインチェックエラー:', error);
                }
            }

            updatePasswordStrength(password) {
                const strengthBar = document.getElementById('strengthBar');
                const strengthText = document.getElementById('strengthText');
                
                let strength = 0;
                let text = 'パスワード強度: ';
                
                if (password.length >= 8) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[a-z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;

                strengthBar.className = 'strength-bar';
                
                if (strength <= 1) {
                    strengthBar.classList.add('weak');
                    text += '弱い';
                } else if (strength <= 2) {
                    strengthBar.classList.add('fair');
                    text += '普通';
                } else if (strength <= 3) {
                    strengthBar.classList.add('good');
                    text += '良い';
                } else {
                    strengthBar.classList.add('strong');
                    text += '強い';
                }
                
                strengthText.textContent = text;
            }

            validateField(field) {
                const group = field.closest('.form-group');
                const errorDiv = group.querySelector('.error');
                let isValid = true;
                let errorMessage = '';

                group.classList.remove('has-error');

                switch (field.id) {
                    case 'companyName':
                        if (!field.value.trim() || field.value.trim().length < 2) {
                            isValid = false;
                            errorMessage = '会社名は2文字以上で入力してください';
                        }
                        break;
                    case 'subdomain':
                        const subdomainRegex = /^[a-z0-9-]+$/;
                        if (!field.value || !subdomainRegex.test(field.value) || field.value.length < 3) {
                            isValid = false;
                            errorMessage = '英数字とハイフンのみ、3-20文字で入力してください';
                        }
                        break;
                    case 'adminName':
                        if (!field.value.trim()) {
                            isValid = false;
                            errorMessage = '管理者名を入力してください';
                        }
                        break;
                    case 'adminEmail':
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(field.value)) {
                            isValid = false;
                            errorMessage = '有効なメールアドレスを入力してください';
                        }
                        break;
                    case 'adminPassword':
                        if (field.value.length < 8 || !/[A-Za-z]/.test(field.value) || !/[0-9]/.test(field.value)) {
                            isValid = false;
                            errorMessage = '8文字以上で英数字を含むパスワードを設定してください';
                        }
                        break;
                }

                if (!isValid) {
                    group.classList.add('has-error');
                    errorDiv.textContent = errorMessage;
                }

                return isValid;
            }

            validateCurrentStep() {
                const currentSection = document.querySelector(`.form-section[data-section="${this.currentStep}"]`);
                const inputs = currentSection.querySelectorAll('input[required]');
                let isValid = true;

                inputs.forEach(input => {
                    if (!this.validateField(input)) {
                        isValid = false;
                    }
                });

                return isValid;
            }

            nextStep() {
                if (this.currentStep < this.totalSteps) {
                    if (this.validateCurrentStep()) {
                        this.currentStep++;
                        this.updateUI();
                    }
                }
            }

            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateUI();
                }
            }

            updateUI() {
                // セクション表示切り替え
                document.querySelectorAll('.form-section').forEach((section, index) => {
                    section.classList.toggle('active', index + 1 === this.currentStep);
                });

                // ステップインジケーター更新
                this.updateStepIndicator();

                // ボタン表示制御
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const submitBtn = document.getElementById('submitBtn');

                prevBtn.style.display = this.currentStep > 1 ? 'inline-flex' : 'none';
                nextBtn.style.display = this.currentStep < 3 ? 'inline-flex' : 'none';
                submitBtn.style.display = this.currentStep === 3 ? 'inline-flex' : 'none';
            }

            updateStepIndicator() {
                document.querySelectorAll('.step').forEach((step, index) => {
                    const stepNumber = index + 1;
                    step.classList.remove('active', 'completed');
                    
                    if (stepNumber < this.currentStep) {
                        step.classList.add('completed');
                    } else if (stepNumber === this.currentStep) {
                        step.classList.add('active');
                    }
                });
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                if (!this.validateCurrentStep()) {
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                const loading = submitBtn.querySelector('.loading');
                const icon = submitBtn.querySelector('.fas');
                
                // ローディング状態
                submitBtn.disabled = true;
                loading.style.display = 'inline-block';
                icon.style.display = 'none';

                // フォームデータ収集
                const formData = new FormData(document.getElementById('signupForm'));
                const signupData = {
                    company_name: formData.get('company_name'),
                    subdomain: formData.get('subdomain'),
                    admin_name: formData.get('admin_name'),
                    admin_email: formData.get('admin_email'),
                    admin_password: formData.get('admin_password'),
                    plan: this.selectedPlan,
                    use_system_default: true
                };

                try {
                    const response = await fetch('/api/v1/signup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(signupData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // 成功時
                        this.signupData = result;
                        localStorage.setItem('access_token', result.access_token);
                        
                        // ダッシュボードリンク設定
                        const dashboardLink = document.getElementById('dashboardLink');
                        dashboardLink.href = `https://${result.domain}`;
                        
                        // 完了ステップへ
                        this.currentStep = 4;
                        this.updateUI();
                        
                        this.showMessage('success', result.message);
                    } else {
                        // エラー時
                        this.showMessage('error', result.detail || 'アカウント作成中にエラーが発生しました');
                    }
                } catch (error) {
                    console.error('サインアップエラー:', error);
                    this.showMessage('error', 'ネットワークエラーが発生しました。しばらく後に再度お試しください。');
                } finally {
                    // ローディング状態解除
                    submitBtn.disabled = false;
                    loading.style.display = 'none';
                    icon.style.display = 'inline-block';
                }
            }

            showMessage(type, message) {
                const successDiv = document.getElementById('successMessage');
                const errorDiv = document.getElementById('errorMessage');
                
                if (type === 'success') {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                } else {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                }

                // メッセージを自動で隠す
                setTimeout(() => {
                    successDiv.style.display = 'none';
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // アプリケーション初期化
        document.addEventListener('DOMContentLoaded', () => {
            new SignupWizard();
        });
    </script>
</body>
</html>